<!DOCTYPE html>
<html>

<head>
    <title>Temp Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.5.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.min.css" />

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/leaflet@1.5.1/dist/leaflet.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <script src="scripts/TileLayer.Grayscale.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <style>
        body,
        html {
            margin: 0;
            height: 100%;
            padding: 0;
        }

        .flex-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #map {
            flex: 1;
        }

        .info.legend {
            background-color: white;
            padding-left: 14px;
            padding-right: 14px;
            font-size: 14px;
            padding-top: 10px;
            padding-bottom: 10px;
            border: 1px solid lightgray;
            border-radius: 40px;
        }
    </style>

</head>

<body>
    <div class="flex-container">
        <div id="map"></div>
        <div id="buttons-container"></div>
    </div>

    <script>
        var map = L.map('map', {
            zoomSnap: 0,
            zoom: 9,
            zoomControl: false,
            fullscreenControl: true,
            center: [55.75371, 37.6198134]
        });

        L.tileLayer.grayscale(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
                attribution: '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }
        ).addTo(map);

        let pointsArr = [];
        var pointsTemp = [];

        var colorsArr = [
            "62008f",
            "5d0092",
            "580095",
            "530098",
            "4c009c",
            "45009f",
            "3c00a2",
            "3100a6",
            "2100a9",
            "0000ad",
            "003694",
            "00409d",
            "004ba5",
            "0055ad",
            "005fb4",
            "0069ba",
            "0073c1",
            "007ec6",
            "0088cb",
            "0092d0",
            "009cd5",
            "00a6d9",
            "1db0dd",
            "32bae1",
            "43c4e5",
            "53cde9",
            "63d7ed",
            "72e1f1",
            "81ebf5",
            "90f4f9",
            "9ffefe",
            "f0fec8",
            "ecf7b9",
            "e9f0a9",
            "e7e999",
            "e6e18a",
            "e6d97b",
            "e6d06c",
            "e7c85d",
            "e8bf4f",
            "e9b540",
            "ebab32",
            "eda124",
            "ef9615",
            "f28a02",
            "f47d00",
            "f67000",
            "f96000",
            "fb4e00",
            "fd3600",
            "ff0000",
            "ff0011",
            "ff001c",
            "ff0025",
            "fe002d",
            "fc0036",
            "f9003d",
            "f70044",
            "f5004a",
            "f2004f",
            "f00055",
            "ed005a",
            "eb005f",
            "e80063",
            "e50068",
            "e2006c",
            "de0071",
            "da0075",
            "d50079",
            "d1017d",
            "cc0f80"
        ];

        getData();

        function getData() {
            $.ajax({
                type: "get",
                url: 'https://api.allorigins.win/raw?url=https://cugms.ru/url',
                dataType: "text",
                async: false,
                success: function (response) {
                    var rows = response.split(/\r?\n|\r/);

                    var curDate = ""

                    pointsArr = [];

                    var latMax = -999;
                    var latMin = 990;
                    var lonMax = -999;
                    var lonMin = 990;

                    for (var i = 1; i < rows.length; i++) {
                        var rowData = (rows[i].split(';'));

                        var lat = parseFloat(rowData[1]);
                        var lon = parseFloat(rowData[2]);
                        var temp = parseFloat(rowData[5])

                        if (!isNaN(lat) && !isNaN(lon) && !isNaN(temp)) {
                            if (lat > latMax) latMax = lat;
                            if (lat < latMin) latMin = lat;
                            if (lon > lonMax) lonMax = lon;
                            if (lon < lonMin) lonMin = lon;

                            pointsArr.push([lat, lon])
                            pointsTemp.push([lat, lon, temp])

                            curDate = rowData[10];
                        }
                    }

                    // console.log(pointsArr);

                    // console.log(latMin);
                    // console.log(lonMin);
                    // console.log(latMax);
                    // console.log(lonMax);

                    var theLegend = L.control({ position: 'topleft' });
                    theLegend.onAdd = function (map) {
                        var div = L.DomUtil.create('div', 'info legend');
                        div.innerHTML += 'Данные на ' + curDate + ' МСК';
                        return div;
                    };
                    theLegend.addTo(map);


                    for (const piont of pointsTemp) {
                        var marker = new L.marker([piont[0], piont[1]], { opacity: 0 });

                        marker.bindTooltip("" + piont[2], {
                            permanent: true,
                            direction: 'center',
                            className: "my-labels"
                        });

                        marker.addTo(map);

                    }

                    const delaunay = d3.Delaunay.from(pointsArr);

                    const voronoi = delaunay.voronoi([latMin - 0.5, lonMin - 0.5, latMax + 0.5, lonMax + 0.5]);

                    for (let index = 0; index < pointsArr.length; index++) {
                        const cellPolygon = voronoi.cellPolygon(index);

                        pointsTemp.forEach(element => {
                            if (voronoi.contains(index, element[0], element[1])) {
                                var colorEl = colorsArr[Math.round(element[2] + 30.0)];

                                L.polygon(
                                    cellPolygon,
                                    {
                                        color: "#000000",
                                        weight: 3,
                                        fillColor: "#" + colorEl,
                                        fillOpacity: 0.3
                                    }
                                ).addTo(map);
                            }
                        });
                    }
                }
            })
        };

    </script>
</body>

</html>